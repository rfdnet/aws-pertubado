"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReadableCloudAssembly = void 0;
const node_fs_1 = require("node:fs");
/**
 * The canonical implementation of `IReadableCloudAssembly`
 *
 * Holds a read lock that is unlocked on disposal, as well as optionally deletes the
 * cloud assembly directory.
 */
class ReadableCloudAssembly {
    cloudAssembly;
    lock;
    options;
    constructor(cloudAssembly, lock, options) {
        this.cloudAssembly = cloudAssembly;
        this.lock = lock;
        this.options = options;
    }
    async _unlock() {
        return this.lock.release();
    }
    async dispose() {
        await this.lock.release();
        if (this.options?.deleteOnDispose) {
            await node_fs_1.promises.rm(this.cloudAssembly.directory, { recursive: true, force: true });
        }
    }
    [Symbol.asyncDispose]() {
        return this.dispose();
    }
}
exports.ReadableCloudAssembly = ReadableCloudAssembly;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZGFibGUtYXNzZW1ibHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWFkYWJsZS1hc3NlbWJseS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBeUM7QUFjekM7Ozs7O0dBS0c7QUFDSCxNQUFhLHFCQUFxQjtJQUVkO0lBQ0M7SUFDQTtJQUhuQixZQUNrQixhQUFrQyxFQUNqQyxJQUFlLEVBQ2YsT0FBc0M7UUFGdkMsa0JBQWEsR0FBYixhQUFhLENBQXFCO1FBQ2pDLFNBQUksR0FBSixJQUFJLENBQVc7UUFDZixZQUFPLEdBQVAsT0FBTyxDQUErQjtJQUV6RCxDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU87UUFDbEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTztRQUNsQixNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDMUIsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDO1lBQ2xDLE1BQU0sa0JBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzlFLENBQUM7SUFDSCxDQUFDO0lBRU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1FBQzFCLE9BQU8sSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3hCLENBQUM7Q0FDRjtBQXRCRCxzREFzQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ25vZGU6ZnMnO1xuaW1wb3J0IHR5cGUgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHR5cGUgeyBJUmVhZExvY2sgfSBmcm9tICcuLi8uLi9zaGFyZWQtcHJpdmF0ZSc7XG5pbXBvcnQgdHlwZSB7IElSZWFkYWJsZUNsb3VkQXNzZW1ibHkgfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVhZGFibGVDbG91ZEFzc2VtYmx5T3B0aW9ucyB7XG4gIC8qKlxuICAgKiBEZWxldGUgdGhlIENsb3VkIEFzc2VtYmx5IGRpcmVjdG9yeSB3aGVuIHRoZSBvYmplY3QgaXMgZGlzcG9zZWRcbiAgICpcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IGRlbGV0ZU9uRGlzcG9zZT86IGJvb2xlYW47XG59XG5cbi8qKlxuICogVGhlIGNhbm9uaWNhbCBpbXBsZW1lbnRhdGlvbiBvZiBgSVJlYWRhYmxlQ2xvdWRBc3NlbWJseWBcbiAqXG4gKiBIb2xkcyBhIHJlYWQgbG9jayB0aGF0IGlzIHVubG9ja2VkIG9uIGRpc3Bvc2FsLCBhcyB3ZWxsIGFzIG9wdGlvbmFsbHkgZGVsZXRlcyB0aGVcbiAqIGNsb3VkIGFzc2VtYmx5IGRpcmVjdG9yeS5cbiAqL1xuZXhwb3J0IGNsYXNzIFJlYWRhYmxlQ2xvdWRBc3NlbWJseSBpbXBsZW1lbnRzIElSZWFkYWJsZUNsb3VkQXNzZW1ibHkge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgY2xvdWRBc3NlbWJseTogY3hhcGkuQ2xvdWRBc3NlbWJseSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxvY2s6IElSZWFkTG9jayxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM/OiBSZWFkYWJsZUNsb3VkQXNzZW1ibHlPcHRpb25zLFxuICApIHtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBfdW5sb2NrKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmxvY2sucmVsZWFzZSgpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRpc3Bvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5sb2NrLnJlbGVhc2UoKTtcbiAgICBpZiAodGhpcy5vcHRpb25zPy5kZWxldGVPbkRpc3Bvc2UpIHtcbiAgICAgIGF3YWl0IGZzLnJtKHRoaXMuY2xvdWRBc3NlbWJseS5kaXJlY3RvcnksIHsgcmVjdXJzaXZlOiB0cnVlLCBmb3JjZTogdHJ1ZSB9KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgW1N5bWJvbC5hc3luY0Rpc3Bvc2VdKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmRpc3Bvc2UoKTtcbiAgfVxufVxuIl19