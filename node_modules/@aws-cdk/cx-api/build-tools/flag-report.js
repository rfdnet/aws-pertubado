"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Generate FEATURE_FLAGS.md, a report of all current feature flags
 */
const fs_1 = require("fs");
const path = require("path");
const feats = require("../lib/features");
const flag_modeling_1 = require("../lib/private/flag-modeling");
async function main() {
    await updateMarkdownFile(path.join(__dirname, '..', 'FEATURE_FLAGS.md'), {
        table: flagsTable(),
        details: flagsDetails(),
        json: recommendedJson(),
        removed: removedFlags(),
        diff: changedFlags(),
        migratejson: migrateJson(),
    });
    // Write to the package root
    await updateRecommendedFlagsFile(path.join(__dirname, '..', '..', 'recommended-feature-flags.json'));
}
function flagsTable() {
    return renderTable([
        ['Flag', 'Summary', 'Since', 'Type'],
        ...v2flags().map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            flag.introducedIn.v2 ?? '',
            renderType(flag.type, 'short'),
        ]),
    ]);
}
function removedFlags() {
    const removedInV2 = flags(flag => flag.introducedIn.v2 === undefined && flag.introducedIn.v1 !== undefined);
    return renderTable([
        ['Flag', 'Summary', 'Type', 'Since'],
        ...removedInV2.map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            renderType(flag.type, 'short'),
            flag.introducedIn.v1 ?? '',
        ]),
    ]);
}
function changedFlags() {
    const changedInV2 = flags(flag => !!flag.defaults?.v2 && !!flag.introducedIn.v2);
    return renderTable([
        ['Flag', 'Summary', 'Type', 'Since', 'v1 default', 'v2 default'],
        ...changedInV2.map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            renderType(flag.type, 'short'),
            flag.introducedIn.v1 ?? '',
            renderValue(false),
            renderValue(flag.defaults?.v2),
        ]),
    ]);
}
function migrateJson() {
    const changedInV2 = flags(flag => !!flag.defaults?.v2 && !!flag.introducedIn.v2 && !!flag.introducedIn.v1);
    const context = Object.fromEntries(changedInV2.map(([name, _]) => [name, false]));
    return [
        '```json',
        JSON.stringify({ context }, undefined, 2),
        '```',
    ].join('\n');
}
function flagsDetails() {
    const allFlags = flags(_ => true);
    return allFlags.flatMap(([name, flag]) => [
        `### ${flagDetailsHeading(name, flag)}`,
        '',
        `*${flag.summary}*`,
        '',
        `Flag type: ${renderType(flag.type, 'long')}`,
        '',
        dedent(flag.detailsMd),
        '',
        renderTable([
            ['Since', 'Default', 'Recommended'],
            // V1
            flag.introducedIn.v1
                ? [flag.introducedIn.v1, renderValue(false), renderValue(flag.recommendedValue)]
                : ['(not in v1)', '', ''],
            // V2
            flag.introducedIn.v2
                ? [flag.introducedIn.v2, renderValue(flag.defaults?.v2 ?? false), renderValue(flag.recommendedValue)]
                : flag.defaults?.v2 !== undefined
                    ? ['(default in v2)', renderValue(flag.defaults?.v2), '']
                    : ['(not in v2)', '', ''],
        ]),
        ...oldBehavior(flag) ? [
            `**Compatibility with old behavior:** ${oldBehavior(flag)}`,
            '',
        ] : [],
        '',
    ]).join('\n');
}
function oldBehavior(flag) {
    switch (flag.type) {
        case flag_modeling_1.FlagType.ApiDefault: return flag.compatibilityWithOldBehaviorMd;
        case flag_modeling_1.FlagType.BugFix: return flag.compatibilityWithOldBehaviorMd;
        case flag_modeling_1.FlagType.VisibleContext: return undefined;
        case flag_modeling_1.FlagType.Temporary: return flag.compatibilityWithOldBehaviorMd;
    }
}
function recommendedJson() {
    return [
        '```json',
        JSON.stringify({ context: feats.CURRENTLY_RECOMMENDED_FLAGS }, undefined, 2),
        '```',
    ].join('\n');
}
function v2flags() {
    return flags(flag => flag.introducedIn.v2 !== undefined);
}
function flags(pred) {
    const entries = Object.entries(feats.FLAGS)
        .filter(([_, flag]) => pred(flag));
    entries.sort((a, b) => firstCmp(
    // Sort by versions first
    (0, flag_modeling_1.compareVersions)(a[1].introducedIn.v2, b[1].introducedIn.v2), (0, flag_modeling_1.compareVersions)(a[1].introducedIn.v1, b[1].introducedIn.v1), 
    // Then sort by name
    a[0].localeCompare(b[0])));
    return entries;
}
function renderType(type, flavor) {
    switch (type) {
        case flag_modeling_1.FlagType.ApiDefault: return longShort('New default behavior', 'new default');
        case flag_modeling_1.FlagType.BugFix: return longShort('Backwards incompatible bugfix', 'fix');
        case flag_modeling_1.FlagType.VisibleContext: return longShort('Configuration option', 'config');
        case flag_modeling_1.FlagType.Temporary: return longShort('Temporary flag', 'temporary');
    }
    function longShort(long, short) {
        return flavor === 'long' ? long : short;
    }
}
function renderTable(rows) {
    return [
        '',
        '| ' + rows[0].join(' | ') + ' |',
        '| ' + rows[0].map(_ => '-----').join(' | ') + ' |',
        ...rows.slice(1).map(row => '| ' + row.join(' | ') + ' |'),
        '',
    ].join('\n');
}
/**
 * Return the heading that will be used to caption this flag's details
 */
function flagDetailsHeading(name, _) {
    return name;
}
/**
 * Return a link that is valid on GitHub to refer to a heading
 */
function githubHeadingLink(heading) {
    return `#${heading.toLowerCase().replace(/ /g, '-').replace(/[^a-z0-9_-]/g, '')}`;
}
/**
 * Remove shared leading whitespace from all non-empty lines
 */
function dedent(body) {
    const lines = body.split('\n').filter((x) => x.trim() !== '');
    const leadingWs = lines.map(x => x.match(/^ */)?.[0].length ?? 0);
    const sharedWs = Math.min(...leadingWs);
    const re = new RegExp('^' + ' '.repeat(sharedWs), 'mg');
    return body.replace(re, '').trim();
}
function renderValue(x) {
    return `\`${JSON.stringify(x)}\``;
}
function renderLink(caption, link) {
    return `[${caption}](${link})`;
}
function mdEsc(x) {
    return x.replace(/_/g, '\\_');
}
async function updateMarkdownFile(filename, sections) {
    let contents = await fs_1.promises.readFile(filename, { encoding: 'utf-8' });
    for (const [section, value] of Object.entries(sections)) {
        const re = new RegExp(`<!-- BEGIN ${section} -->(.*)<!-- END ${section} -->`, 's');
        contents = contents.replace(re, `<!-- BEGIN ${section} -->\n${value}\n<!-- END ${section} -->`);
    }
    await fs_1.promises.writeFile(filename, contents, { encoding: 'utf-8' });
}
async function updateRecommendedFlagsFile(filename) {
    await fs_1.promises.writeFile(filename, JSON.stringify(feats.CURRENTLY_RECOMMENDED_FLAGS, undefined, 2), { encoding: 'utf-8' });
}
function firstCmp(...xs) {
    return xs.find(x => x !== 0) ?? 0;
}
main().catch(e => {
    // eslint-disable-next-line no-console
    console.error(e);
    process.exitCode = 1;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhZy1yZXBvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmbGFnLXJlcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOztHQUVHO0FBQ0gsMkJBQW9DO0FBQ3BDLDZCQUE2QjtBQUM3Qix5Q0FBeUM7QUFDekMsZ0VBQW1GO0FBRW5GLEtBQUssVUFBVSxJQUFJO0lBQ2pCLE1BQU0sa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLGtCQUFrQixDQUFDLEVBQUU7UUFDdkUsS0FBSyxFQUFFLFVBQVUsRUFBRTtRQUNuQixPQUFPLEVBQUUsWUFBWSxFQUFFO1FBQ3ZCLElBQUksRUFBRSxlQUFlLEVBQUU7UUFDdkIsT0FBTyxFQUFFLFlBQVksRUFBRTtRQUN2QixJQUFJLEVBQUUsWUFBWSxFQUFFO1FBQ3BCLFdBQVcsRUFBRSxXQUFXLEVBQUU7S0FDM0IsQ0FBQyxDQUFDO0lBRUgsNEJBQTRCO0lBQzVCLE1BQU0sMEJBQTBCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxnQ0FBZ0MsQ0FBQyxDQUFDLENBQUM7QUFDdkcsQ0FBQztBQUVELFNBQVMsVUFBVTtJQUNqQixPQUFPLFdBQVcsQ0FBQztRQUNqQixDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQztRQUNwQyxHQUFHLE9BQU8sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FDaEM7WUFDRSxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLGlCQUFpQixDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzFFLElBQUksQ0FBQyxPQUFPO1lBQ1osSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLElBQUksRUFBRTtZQUMxQixVQUFVLENBQUMs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SyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1FBQ3hELE1BQU0sRUFBRSxHQUFHLElBQUksTUFBTSxDQUFDLGNBQWMsT0FBTyxvQkFBb0IsT0FBTyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbkYsUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLGNBQWMsT0FBTyxTQUFTLEtBQUssY0FBYyxPQUFPLE1BQU0sQ0FBQyxDQUFDO0lBQ2xHLENBQUM7SUFFRCxNQUFNLGFBQUUsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO0FBQ2hFLENBQUM7QUFFRCxLQUFLLFVBQVUsMEJBQTBCLENBQUMsUUFBZ0I7SUFDeEQsTUFBTSxhQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztBQUN2SCxDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsR0FBRyxFQUFZO0lBQy9CLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtJQUNmLHNDQUFzQztJQUN0QyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLE9BQU8sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBHZW5lcmF0ZSBGRUFUVVJFX0ZMQUdTLm1kLCBhIHJlcG9ydCBvZiBhbGwgY3VycmVudCBmZWF0dXJlIGZsYWdzXG4gKi9cbmltcG9ydCB7IHByb21pc2VzIGFzIGZzIH0gZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZlYXRzIGZyb20gJy4uL2xpYi9mZWF0dXJlcyc7XG5pbXBvcnQgeyBGbGFnSW5mbywgRmxhZ1R5cGUsIGNvbXBhcmVWZXJzaW9ucyB9IGZyb20gJy4uL2xpYi9wcml2YXRlL2ZsYWctbW9kZWxpbmcnO1xuXG5hc3luYyBmdW5jdGlvbiBtYWluKCkge1xuICBhd2FpdCB1cGRhdGVNYXJrZG93bkZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJ0ZFQVRVUkVfRkxBR1MubWQnKSwge1xuICAgIHRhYmxlOiBmbGFnc1RhYmxlKCksXG4gICAgZGV0YWlsczogZmxhZ3NEZXRhaWxzKCksXG4gICAganNvbjogcmVjb21tZW5kZWRKc29uKCksXG4gICAgcmVtb3ZlZDogcmVtb3ZlZEZsYWdzKCksXG4gICAgZGlmZjogY2hhbmdlZEZsYWdzKCksXG4gICAgbWlncmF0ZWpzb246IG1pZ3JhdGVKc29uKCksXG4gIH0pO1xuXG4gIC8vIFdyaXRlIHRvIHRoZSBwYWNrYWdlIHJvb3RcbiAgYXdhaXQgdXBkYXRlUmVjb21tZW5kZWRGbGFnc0ZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3JlY29tbWVuZGVkLWZlYXR1cmUtZmxhZ3MuanNvbicpKTtcbn1cblxuZnVuY3Rpb24gZmxhZ3NUYWJsZSgpIHtcbiAgcmV0dXJuIHJlbmRlclRhYmxlKFtcbiAgICBbJ0ZsYWcnLCAnU3VtbWFyeScsICdTaW5jZScsICdUeXBlJ10sXG4gICAgLi4udjJmbGFncygpLm1hcCgoW25hbWUsIGZsYWddKSA9PlxuICAgICAgW1xuICAgICAgICByZW5kZXJMaW5rKG1kRXNjKG5hbWUpLCBnaXRodWJIZWFkaW5nTGluayhmbGFnRGV0YWlsc0hlYWRpbmcobmFtZSwgZmxhZykpKSxcbiAgICAgICAgZmxhZy5zdW1tYXJ5LFxuICAgICAgICBmbGFnLmludHJvZHVjZWRJbi52MiA/PyAnJyxcbiAgICAgICAgcmVuZGVyVHlwZShmbGFnLnR5cGUsICdzaG9ydCcpLFxuICAgICAgXSxcbiAgICApLFxuICBdKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlZEZsYWdzKCkge1xuICBjb25zdCByZW1vdmVkSW5WMiA9IGZsYWdzKGZsYWcgPT4gZmxhZy5pbnRyb2R1Y2VkSW4udjIgPT09IHVuZGVmaW5lZCAmJiBmbGFnLmludHJvZHVjZWRJbi52MSAhPT0gdW5kZWZpbmVkKTtcblxuICByZXR1cm4gcmVuZGVyVGFibGUoW1xuICAgIFsnRmxhZycsICdTdW1tYXJ5JywgJ1R5cGUnLCAnU2luY2UnXSxcbiAgICAuLi5yZW1vdmVkSW5WMi5tYXAoKFtuYW1lLCBmbGFnXSkgPT4gW1xuICAgICAgcmVuZGVyTGluayhtZEVzYyhuYW1lKSwgZ2l0aHViSGVhZGluZ0xpbmsoZmxhZ0RldGFpbHNIZWFkaW5nKG5hbWUsIGZsYWcpKSksXG4gICAgICBmbGFnLnN1bW1hcnksXG4gICAgICByZW5kZXJUeXBlKGZsYWcudHlwZSwgJ3Nob3J0JyksXG4gICAgICBmbGFnLmludHJvZHVjZWRJbi52MSA/PyAnJyxcbiAgICBdKSxcbiAgXSk7XG59XG5cbmZ1bmN0aW9uIGNoYW5nZWRGbGFncygpIHtcbiAgY29uc3QgY2hhbmdlZEluVjIgPSBmbGFncyhmbGFnID0+ICEhZmxhZy5kZWZhdWx0cz8udjIgJiYgISFmbGFnLmludHJvZHVjZWRJbi52Mik7XG5cbiAgcmV0dXJuIHJlbmRlclRhYmxlKFtcbiAgICBbJ0ZsYWcnLCAnU3VtbWFyeScsICdUeXBlJywgJ1NpbmNlJywgJ3YxIGRlZmF1bHQnLCAndjIgZGVmYXVsdCddLFxuICAgIC4uLmNoYW5nZWRJblYyLm1hcCgoW25hbWUsIGZsYWddKSA9PiBbXG4gICAgICByZW5kZXJMaW5rKG1kRXNjKG5hbWUpLCBnaXRodWJIZWFkaW5nTGluayhmbGFnRGV0YWlsc0hlYWRpbmcobmFtZSwgZmxhZykpKSxcbiAgICAgIGZsYWcuc3VtbWFyeSxcbiAgICAgIHJlbmRlclR5cGUoZmxhZy50eXBlLCAnc2hvcnQnKSxcbiAgICAgIGZsYWcuaW50cm9kdWNlZEluLnYxID8/ICcnLFxuICAgICAgcmVuZGVyVmFsdWUoZmFsc2UpLFxuICAgICAgcmVuZGVyVmFsdWUoZmxhZy5kZWZhdWx0cz8udjIpLFxuICAgIF0pLFxuICBdKTtcbn1cblxuZnVuY3Rpb24gbWlncmF0ZUpzb24oKSB7XG4gIGNvbnN0IGNoYW5nZWRJblYyID0gZmxhZ3MoZmxhZyA9PiAhIWZsYWcuZGVmYXVsdHM/LnYyICYmICEhZmxhZy5pbnRyb2R1Y2VkSW4udjIgJiYgISFmbGFnLmludHJvZHVjZWRJbi52MSk7XG5cbiAgY29uc3QgY29udGV4dCA9IE9iamVjdC5mcm9tRW50cmllcyhjaGFuZ2VkSW5WMi5tYXAoKFtuYW1lLCBfXSkgPT4gW25hbWUsIGZhbHNlXSkpO1xuXG4gIHJldHVybiBbXG4gICAgJ2BgYGpzb24nLFxuICAgIEpTT04uc3RyaW5naWZ5KHsgY29udGV4dCB9LCB1bmRlZmluZWQsIDIpLFxuICAgICdgYGAnLFxuICBdLmpvaW4oJ1xcbicpO1xufVxuXG5mdW5jdGlvbiBmbGFnc0RldGFpbHMoKSB7XG4gIGNvbnN0IGFsbEZsYWdzID0gZmxhZ3MoXyA9PiB0cnVlKTtcblxuICByZXR1cm4gYWxsRmxhZ3MuZmxhdE1hcCgoW25hbWUsIGZsYWddKSA9PiBbXG4gICAgYCMjIyAke2ZsYWdEZXRhaWxzSGVhZGluZyhuYW1lLCBmbGFnKX1gLFxuICAgICcnLFxuICAgIGAqJHtmbGFnLnN1bW1hcnl9KmAsXG4gICAgJycsXG4gICAgYEZsYWcgdHlwZTogJHtyZW5kZXJUeXBlKGZsYWcudHlwZSwgJ2xvbmcnKX1gLFxuICAgICcnLFxuICAgIGRlZGVudChmbGFnLmRldGFpbHNNZCksXG4gICAgJycsXG4gICAgcmVuZGVyVGFibGUoW1xuICAgICAgWydTaW5jZScsICdEZWZhdWx0JywgJ1JlY29tbWVuZGVkJ10sXG5cbiAgICAgIC8vIFYxXG4gICAgICBmbGFnLmludHJvZHVjZWRJbi52MVxuICAgICAgICA/IFtmbGFnLmludHJvZHVjZWRJbi52MSwgcmVuZGVyVmFsdWUoZmFsc2UpLCByZW5kZXJWYWx1ZShmbGFnLnJlY29tbWVuZGVkVmFsdWUpXVxuICAgICAgICA6IFsnKG5vdCBpbiB2MSknLCAnJywgJyddLFxuXG4gICAgICAvLyBWMlxuICAgICAgZmxhZy5pbnRyb2R1Y2VkSW4udjJcbiAgICAgICAgPyBbZmxhZy5pbnRyb2R1Y2VkSW4udjIsIHJlbmRlclZhbHVlKGZsYWcuZGVmYXVsdHM/LnYyID8/IGZhbHNlKSwgcmVuZGVyVmFsdWUoZmxhZy5yZWNvbW1lbmRlZFZhbHVlKV1cbiAgICAgICAgOiBmbGFnLmRlZmF1bHRzPy52MiAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgPyBbJyhkZWZhdWx0IGluIHYyKScsIHJlbmRlclZhbHVlKGZsYWcuZGVmYXVsdHM/LnYyKSwgJyddXG4gICAgICAgICAgOiBbJyhub3QgaW4gdjIpJywgJycsICcnXSxcbiAgICBdKSxcbiAgICAuLi5vbGRCZWhhdmlvcihmbGFnKSA/IFtcbiAgICAgIGAqKkNvbXBhdGliaWxpdHkgd2l0aCBvbGQgYmVoYXZpb3I6KiogJHtvbGRCZWhhdmlvcihmbGFnKX1gLFxuICAgICAgJycsXG4gICAgXSA6IFtdLFxuICAgICcnLFxuICBdKS5qb2luKCdcXG4nKTtcbn1cblxuZnVuY3Rpb24gb2xkQmVoYXZpb3IoZmxhZzogRmxhZ0luZm8pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBzd2l0Y2ggKGZsYWcudHlwZSkge1xuICAgIGNhc2UgRmxhZ1R5cGUuQXBpRGVmYXVsdDogcmV0dXJuIGZsYWcuY29tcGF0aWJpbGl0eVdpdGhPbGRCZWhhdmlvck1kO1xuICAgIGNhc2UgRmxhZ1R5cGUuQnVnRml4OiByZXR1cm4gZmxhZy5jb21wYXRpYmlsaXR5V2l0aE9sZEJlaGF2aW9yTWQ7XG4gICAgY2FzZSBGbGFnVHlwZS5WaXNpYmxlQ29udGV4dDogcmV0dXJuIHVuZGVmaW5lZDtcbiAgICBjYXNlIEZsYWdUeXBlLlRlbXBvcmFyeTogcmV0dXJuIGZsYWcuY29tcGF0aWJpbGl0eVdpdGhPbGRCZWhhdmlvck1kO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlY29tbWVuZGVkSnNvbigpIHtcbiAgcmV0dXJuIFtcbiAgICAnYGBganNvbicsXG4gICAgSlNPTi5zdHJpbmdpZnkoeyBjb250ZXh0OiBmZWF0cy5DVVJSRU5UTFlfUkVDT01NRU5ERURfRkxBR1MgfSwgdW5kZWZpbmVkLCAyKSxcbiAgICAnYGBgJyxcbiAgXS5qb2luKCdcXG4nKTtcbn1cblxuZnVuY3Rpb24gdjJmbGFncygpIHtcbiAgcmV0dXJuIGZsYWdzKGZsYWcgPT4gZmxhZy5pbnRyb2R1Y2VkSW4udjIgIT09IHVuZGVmaW5lZCk7XG59XG5cbmZ1bmN0aW9uIGZsYWdzKHByZWQ6ICh4OiBGbGFnSW5mbykgPT4gYm9vbGVhbikge1xuICBjb25zdCBlbnRyaWVzID0gT2JqZWN0LmVudHJpZXMoZmVhdHMuRkxBR1MpXG4gICAgLmZpbHRlcigoW18sIGZsYWddKSA9PiBwcmVkKGZsYWcpKTtcblxuICBlbnRyaWVzLnNvcnQoKGEsIGIpID0+IGZpcnN0Q21wKFxuICAgIC8vIFNvcnQgYnkgdmVyc2lvbnMgZmlyc3RcbiAgICBjb21wYXJlVmVyc2lvbnMoYVsxXS5pbnRyb2R1Y2VkSW4udjIsIGJbMV0uaW50cm9kdWNlZEluLnYyKSxcbiAgICBjb21wYXJlVmVyc2lvbnMoYVsxXS5pbnRyb2R1Y2VkSW4udjEsIGJbMV0uaW50cm9kdWNlZEluLnYxKSxcbiAgICAvLyBUaGVuIHNvcnQgYnkgbmFtZVxuICAgIGFbMF0ubG9jYWxlQ29tcGFyZShiWzBdKSkpO1xuXG4gIHJldHVybiBlbnRyaWVzO1xufVxuXG5mdW5jdGlvbiByZW5kZXJUeXBlKHR5cGU6IEZsYWdUeXBlLCBmbGF2b3I6ICdzaG9ydCcgfCAnbG9uZycpOiBzdHJpbmcge1xuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlIEZsYWdUeXBlLkFwaURlZmF1bHQ6IHJldHVybiBsb25nU2hvcnQoJ05ldyBkZWZhdWx0IGJlaGF2aW9yJywgJ25ldyBkZWZhdWx0Jyk7XG4gICAgY2FzZSBGbGFnVHlwZS5CdWdGaXg6IHJldHVybiBsb25nU2hvcnQoJ0JhY2t3YXJkcyBpbmNvbXBhdGlibGUgYnVnZml4JywgJ2ZpeCcpO1xuICAgIGNhc2UgRmxhZ1R5cGUuVmlzaWJsZUNvbnRleHQ6IHJldHVybiBsb25nU2hvcnQoJ0NvbmZpZ3VyYXRpb24gb3B0aW9uJywgJ2NvbmZpZycpO1xuICAgIGNhc2UgRmxhZ1R5cGUuVGVtcG9yYXJ5OiByZXR1cm4gbG9uZ1Nob3J0KCdUZW1wb3JhcnkgZmxhZycsICd0ZW1wb3JhcnknKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGxvbmdTaG9ydChsb25nOiBzdHJpbmcsIHNob3J0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZmxhdm9yID09PSAnbG9uZycgPyBsb25nIDogc2hvcnQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVuZGVyVGFibGUocm93czogc3RyaW5nW11bXSkge1xuICByZXR1cm4gW1xuICAgICcnLFxuICAgICd8ICcgKyByb3dzWzBdLmpvaW4oJyB8ICcpICsgJyB8JyxcbiAgICAnfCAnICsgcm93c1swXS5tYXAoXyA9PiAnLS0tLS0nKS5qb2luKCcgfCAnKSArICcgfCcsXG4gICAgLi4ucm93cy5zbGljZSgxKS5tYXAocm93ID0+ICd8ICcgKyByb3cuam9pbignIHwgJykgKyAnIHwnKSxcbiAgICAnJyxcbiAgXS5qb2luKCdcXG4nKTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gdGhlIGhlYWRpbmcgdGhhdCB3aWxsIGJlIHVzZWQgdG8gY2FwdGlvbiB0aGlzIGZsYWcncyBkZXRhaWxzXG4gKi9cbmZ1bmN0aW9uIGZsYWdEZXRhaWxzSGVhZGluZyhuYW1lOiBzdHJpbmcsIF86IEZsYWdJbmZvKSB7XG4gIHJldHVybiBuYW1lO1xufVxuXG4vKipcbiAqIFJldHVybiBhIGxpbmsgdGhhdCBpcyB2YWxpZCBvbiBHaXRIdWIgdG8gcmVmZXIgdG8gYSBoZWFkaW5nXG4gKi9cbmZ1bmN0aW9uIGdpdGh1YkhlYWRpbmdMaW5rKGhlYWRpbmc6IHN0cmluZykge1xuICByZXR1cm4gYCMke2hlYWRpbmcudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8gL2csICctJykucmVwbGFjZSgvW15hLXowLTlfLV0vZywgJycpfWA7XG59XG5cbi8qKlxuICogUmVtb3ZlIHNoYXJlZCBsZWFkaW5nIHdoaXRlc3BhY2UgZnJvbSBhbGwgbm9uLWVtcHR5IGxpbmVzXG4gKi9cbmZ1bmN0aW9uIGRlZGVudChib2R5OiBzdHJpbmcpIHtcbiAgY29uc3QgbGluZXMgPSBib2R5LnNwbGl0KCdcXG4nKS5maWx0ZXIoKHgpID0+IHgudHJpbSgpICE9PSAnJyk7XG4gIGNvbnN0IGxlYWRpbmdXcyA9IGxpbmVzLm1hcCh4ID0+IHgubWF0Y2goL14gKi8pPy5bMF0ubGVuZ3RoID8/IDApO1xuICBjb25zdCBzaGFyZWRXcyA9IE1hdGgubWluKC4uLmxlYWRpbmdXcyk7XG4gIGNvbnN0IHJlID0gbmV3IFJlZ0V4cCgnXicgKyAnICcucmVwZWF0KHNoYXJlZFdzKSwgJ21nJyk7XG4gIHJldHVybiBib2R5LnJlcGxhY2UocmUsICcnKS50cmltKCk7XG59XG5cbmZ1bmN0aW9uIHJlbmRlclZhbHVlKHg6IGFueSkge1xuICByZXR1cm4gYFxcYCR7SlNPTi5zdHJpbmdpZnkoeCl9XFxgYDtcbn1cblxuZnVuY3Rpb24gcmVuZGVyTGluayhjYXB0aW9uOiBzdHJpbmcsIGxpbms6IHN0cmluZykge1xuICByZXR1cm4gYFske2NhcHRpb259XSgke2xpbmt9KWA7XG59XG5cbmZ1bmN0aW9uIG1kRXNjKHg6IHN0cmluZykge1xuICByZXR1cm4geC5yZXBsYWNlKC9fL2csICdcXFxcXycpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVNYXJrZG93bkZpbGUoZmlsZW5hbWU6IHN0cmluZywgc2VjdGlvbnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pIHtcbiAgbGV0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUoZmlsZW5hbWUsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSk7XG5cbiAgZm9yIChjb25zdCBbc2VjdGlvbiwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNlY3Rpb25zKSkge1xuICAgIGNvbnN0IHJlID0gbmV3IFJlZ0V4cChgPCEtLSBCRUdJTiAke3NlY3Rpb259IC0tPiguKik8IS0tIEVORCAke3NlY3Rpb259IC0tPmAsICdzJyk7XG4gICAgY29udGVudHMgPSBjb250ZW50cy5yZXBsYWNlKHJlLCBgPCEtLSBCRUdJTiAke3NlY3Rpb259IC0tPlxcbiR7dmFsdWV9XFxuPCEtLSBFTkQgJHtzZWN0aW9ufSAtLT5gKTtcbiAgfVxuXG4gIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlbmFtZSwgY29udGVudHMsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVJlY29tbWVuZGVkRmxhZ3NGaWxlKGZpbGVuYW1lOiBzdHJpbmcpIHtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKGZpbGVuYW1lLCBKU09OLnN0cmluZ2lmeShmZWF0cy5DVVJSRU5UTFlfUkVDT01NRU5ERURfRkxBR1MsIHVuZGVmaW5lZCwgMiksIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSk7XG59XG5cbmZ1bmN0aW9uIGZpcnN0Q21wKC4uLnhzOiBudW1iZXJbXSkge1xuICByZXR1cm4geHMuZmluZCh4ID0+IHggIT09IDApID8/IDA7XG59XG5cbm1haW4oKS5jYXRjaChlID0+IHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgY29uc29sZS5lcnJvcihlKTtcbiAgcHJvY2Vzcy5leGl0Q29kZSA9IDE7XG59KTtcbiJdfQ==